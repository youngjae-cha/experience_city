import os
import zipfile
import shutil
from multiprocessing import Pool

# 1. Define the paths
base_folder = "data"  # Folder where zip files are located
output_folder = "unpacked_csv"  # Destination folder for all CSV files

# Ensure the output folder exists
os.makedirs(output_folder, exist_ok=True)

def process_zip_file(zip_file):
    zip_path = os.path.join(base_folder, zip_file)
    try:
        with zipfile.ZipFile(zip_path, 'r') as zip_ref:
            temp_folder = os.path.join(base_folder, f"temp_{zip_file}")  # Temporary folder for extraction
            os.makedirs(temp_folder, exist_ok=True)
            zip_ref.extractall(temp_folder)  # Extract the zip file to the temp folder

            # Find city folders inside the "oishilab" folder
            oishilab_path = os.path.join(temp_folder, "oishilab")
            if os.path.exists(oishilab_path):
                for city_name in os.listdir(oishilab_path):
                    city_folder = os.path.join(oishilab_path, city_name)
                    if os.path.isdir(city_folder):
                        # Process all CSV files in the city folder
                        for csv_file in os.listdir(city_folder):
                            if csv_file.endswith(".csv"):
                                original_csv_path = os.path.join(city_folder, csv_file)
                                new_csv_name = f"{city_name}_{csv_file}"
                                new_csv_path = os.path.join(output_folder, new_csv_name)
                                shutil.move(original_csv_path, new_csv_path)  # Move to output folder

            # Clean up the temp folder
            shutil.rmtree(temp_folder)
    except Exception as e:
        print(f"Error processing {zip_file}: {e}")

# Get the list of zip files
zip_files = [file for file in os.listdir(base_folder) if file.endswith(".zip")]

# Use multiprocessing to process zip files in parallel
if __name__ == "__main__":
    with Pool(60) as pool:  # Use 60 cores
        pool.map(process_zip_file, zip_files)

print("All CSV files have been extracted and renamed successfully!")
